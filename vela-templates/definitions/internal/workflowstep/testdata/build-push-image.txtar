# Test for build-push-image workflow step
# Based on references/docgen/def-doc/workflowstep/build-push-image.eg.md

-- in.cue --
import (
	"strings"
)

"build-push-image": {
	alias: ""
	attributes: {}
	description: "Build and push image from git url"
	annotations: {
		"category": "CI Integration"
	}
	labels: {}
	type: "workflow-step"
}

template: {
	// Mock context values that would be provided by KubeVela at runtime
	context: {
		name:           "build-push"
		stepSessionID:  "test-session-123"
		namespace:      "default"
	}

	// User-provided parameters from the workflow step
	parameter: {
		kanikoExecutor: "oamdev/kaniko-executor:v1.9.1"
		context: {
			git:    "github.com/FogDong/simple-web-demo"
			branch: "main"
		}
		dockerfile: "./Dockerfile"
		image:      "fogdong/simple-web-demo:v1"
		verbosity:  "info"
		credentials: {
			image: {
				name: "image-secret"
				key:  ".dockerconfigjson"
			}
		}
	}

	// Build the context URL
	url: {
		if parameter.context.git != _|_ {
			address: strings.TrimPrefix(parameter.context.git, "git://")
			value:   "git://\(address)#refs/heads/\(parameter.context.branch)"
		}
		if parameter.context.git == _|_ {
			value: parameter.context
		}
	}

	// Generate the Kaniko Pod specification
	kaniko: {
		value: {
			apiVersion: "v1"
			kind:       "Pod"
			metadata: {
				name:      "\(context.name)-\(context.stepSessionID)-kaniko"
				namespace: context.namespace
			}
			spec: {
				containers: [
					{
						args: [
							"--dockerfile=\(parameter.dockerfile)",
							"--context=\(url.value)",
							"--destination=\(parameter.image)",
							"--verbosity=\(parameter.verbosity)",
						]
						image: parameter.kanikoExecutor
						name:  "kaniko"
						if parameter.credentials != _|_ && parameter.credentials.image != _|_ {
							volumeMounts: [
								{
									mountPath: "/kaniko/.docker/"
									name:      parameter.credentials.image.name
								},
							]
						}
					},
				]
				if parameter.credentials != _|_ && parameter.credentials.image != _|_ {
					volumes: [
						{
							name: parameter.credentials.image.name
							secret: {
								defaultMode: 420
								items: [
									{
										key:  parameter.credentials.image.key
										path: "config.json"
									},
								]
								secretName: parameter.credentials.image.name
							}
						},
					]
				}
				restartPolicy: "Never"
			}
		}
	}
}

-- out.cue --
"build-push-image": {
	type:        "workflow-step"
	description: "Build and push image from git url"
}

template: {
	context: {
		name:           "build-push"
		stepSessionID:  "test-session-123"
		namespace:      "default"
	}

	parameter: {
		kanikoExecutor: "oamdev/kaniko-executor:v1.9.1"
		context: {
			git:    "github.com/FogDong/simple-web-demo"
			branch: "main"
		}
		dockerfile: "./Dockerfile"
		image:      "fogdong/simple-web-demo:v1"
		verbosity:  "info"
		credentials: {
			image: {
				name: "image-secret"
				key:  ".dockerconfigjson"
			}
		}
	}

	// Expected URL construction
	url: {
		address: "github.com/FogDong/simple-web-demo"
		value:   "git://github.com/FogDong/simple-web-demo#refs/heads/main"
	}

	// Expected Kaniko Pod specification
	kaniko: {
		value: {
			apiVersion: "v1"
			kind:       "Pod"
			metadata: {
				name:      "build-push-test-session-123-kaniko"
				namespace: "default"
			}
			spec: {
				containers: [{
					name:  "kaniko"
					image: "oamdev/kaniko-executor:v1.9.1"
					args: [
						"--dockerfile=./Dockerfile",
						"--context=git://github.com/FogDong/simple-web-demo#refs/heads/main",
						"--destination=fogdong/simple-web-demo:v1",
						"--verbosity=info",
					]
					volumeMounts: [{
						mountPath: "/kaniko/.docker/"
						name:      "image-secret"
					}]
				}]
				volumes: [{
					name: "image-secret"
					secret: {
						defaultMode: 420
						secretName:  "image-secret"
						items: [{
							key:  ".dockerconfigjson"
							path: "config.json"
						}]
					}
				}]
				restartPolicy: "Never"
			}
		}
	}
}
