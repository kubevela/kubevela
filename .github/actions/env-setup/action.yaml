name: 'Kubevela Test Environment Setup'
description: 'Sets up complete testing environment for Kubevela with Go, Kubernetes tools, and Ginkgo framework for E2E testing.'

inputs:
  go-version:
    description: 'Go version to use for testing'
    required: false
    default: '1.23.8'


runs:
  using: 'composite'
  steps:
    # ========================================================================
    # Environment Setup
    # ========================================================================
    - name: Install system dependencies
      shell: bash
      run: |
        # Update package manager and install essential tools
        sudo apt-get update
        sudo apt-get install -y \
          make \
          gcc \
          jq \
          ca-certificates \
          curl \
          gnupg

    - name: Install kubectl and helm
      shell: bash
      run: |
        # Install kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/

        # Install helm
        HELM_VERSION=$(curl -s https://api.github.com/repos/helm/helm/releases/latest | jq -r .tag_name)
        curl -LO https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz
        tar -zxvf helm-${HELM_VERSION}-linux-amd64.tar.gz
        sudo mv linux-amd64/helm /usr/local/bin/helm
        rm -rf linux-amd64 helm-${HELM_VERSION}-linux-amd64.tar.gz
    

    - name: Setup Go environment
      uses: actions/setup-go@0a12ed9d6a96ab950c8f026ed9f722fe0da7ef32
      with:
        go-version: ${{ inputs.go-version }}
        cache: true

    - name: Download Go dependencies
      shell: bash
      run: |
        # Download and cache Go module dependencies
        go mod download
        go mod verify

    - name: Install Ginkgo testing framework
      shell: bash
      run: |
        echo "Installing Ginkgo testing framework..."
        go install github.com/onsi/ginkgo/v2/ginkgo@v2.14.0

    - name: Cache Go Dependencies
      uses: actions/cache@v4
      with:
        path: .work/pkg
        key: ${{ runner.os }}-pkg-${{ hashFiles('**/go.sum') }}
        restore-keys: ${{ runner.os }}-pkg-